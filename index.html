<!doctype html>
<html lang="jp">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="Koki WATANABE, Yakiniku Base Kakeru Ordering System">
  <meta name="generator" content="Hugo 0.84.0">
  <title>Kakeru Ordering System</title>
  <!-- Bootstrap core CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <style>
    .bd-placeholder-img {
      font-size: 1.125rem;
      text-anchor: middle;
      -webkit-user-select: none;
      -moz-user-select: none;
      user-select: none;
    }

    @media (min-width: 768px) {
      .bd-placeholder-img-lg {
        font-size: 3.5rem;
      }
    }
  </style>
</head>

<body>
  <main>

    <div class="container py-4">

      <header class="pb-3 mb-4 border-bottom">
        <a href="/" class="d-flex align-items-center text-dark text-decoration-none">
          <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor"
            class="bi bi-grid-3x3-gap-fill" viewBox="0 0 16 16">
            <path
              d="M1 2a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V2zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1V2zM1 7a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V7zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V7zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1V7zM1 12a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1v-2zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1v-2zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1v-2z" />
          </svg>
          <span class="fs-4 ms-2 fw-bold">Yakiniku Base Kakeru Ordaring System</span>
        </a>
      </header>

      <!--UI:CUSTOM MENU-->
      <div class="p-5 mb-4 bg-light rounded-3">
        <div class="container-fluid py-1">
          <h1 class="display-5 fw-bold">CUSTOM MENU</h1>
          <p class="col-md-8 fs-6">経営陣向け。<br>
            CUSTOM MENU Application は POST ORDER Applicationn に表示される商品一覧を編集することができます.<br>
            対象のGoogleSpreadSheetを編集することでApplicationに反映されます.
          </p>
          <button class="btn btn-primary" type="button" id="startCustomize">START CUSTOMIZE</button>
        </div>
      </div>

      <div class="row align-items-md-stretch">
        <!--UI:POST ORDER-->
        <div class="col-md-6">
          <div class="h-100 p-5 text-white bg-dark rounded-3">
            <h1 class="fw-bold">POST ORDER</h1>
            <p class="fs-6">ホールスタッフ向け。<br>POST ODER Application は注文情報をキッチンに送信します。<br>
              卓番と商品を選択。注文確定ボタンを押下すると<br>
              キッチンに注文情報が送信されます。
            </p>
            <button class="btn btn-outline-light" type="button" data-bs-toggle="modal"
              data-bs-target="#postOrderAppScreen">START POST ORDER</button>
          </div>
        </div>

        <!--UI:RECEIVE ORDER-->
        <div class="col-md-6">
          <div class="h-100 p-5 bg-light border rounded-3">
            <h1 class="fw-bold">RECEIVE ORDER</h1>
            <p class="fs-6">キッチンスタッフ向け。<br>
              RECEVE ORDER Application はホールスタッフからPOSTされた注文情報を一覧表示します。調理完了後、対象の注文情報に表示されている<br>
              DONE を押下すると、一覧から削除されます。
            </p>
            <button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal"
              data-bs-target="#receiveOrderAppScreen">START RECEIVE ORDER</button>
          </div>
        </div>
      </div>

      <!-- POST ORDER Apllication Modal -->
      <div class="modal fade" id="postOrderAppScreen" tabindex="-1" aria-labelledby="exampleModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
          <div class="modal-content">
            <div class="modal-header border-bottom">
              <a href="/" class="d-flex align-items-center text-dark text-decoration-none">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor"
                  class="bi bi-grid-3x3-gap-fill" viewBox="0 0 16 16">
                  <path
                    d="M1 2a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V2zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1V2zM1 7a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V7zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V7zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1V7zM1 12a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1v-2zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1v-2zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1v-2z" />
                </svg>
                <span class="fs-4 ms-2 fw-bold">POST ORDER Application</span>
              </a>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="container modal-body">
              <div class="row">
                <div class="col">
                  <!--卓版表示エリア-->
                  <div id="table" class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3"></div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>

      <!-- RECEIVED ORDER Apllication Modal -->
      <audio src="postAudio.mp3" id="playAudio"></audio>
      <div class="modal fade" id="receiveOrderAppScreen" tabindex="-1" aria-labelledby="exampleModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
          <div class="modal-content">
            <div class="modal-header border-bottom">
              <a href="/" class="d-flex align-items-center text-dark text-decoration-none">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor"
                  class="bi bi-grid-3x3-gap-fill" viewBox="0 0 16 16">
                  <path
                    d="M1 2a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V2zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1V2zM1 7a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V7zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V7zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1V7zM1 12a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1v-2zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1v-2zm5 0a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1v-2z" />
                </svg>
                <span class="fs-4 ms-2 fw-bold">RECEIVED ORDER Application</span>
              </a>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="container modal-body">
              <div class="row">
                <!--注文全体リスト表示エリア-->
                <div id="orderMenuList" class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3"></div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>

      <!--卓番選択後に表示されるモーダルの内容-->
      <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLabel">TABLE #0<span id="tableNumber"></span> 注文追加</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="row">
                <div class="col-md-12">
                  <!--追加する注文一覧-->
                  メニューリスト
                  <ul class="list-group">
                    <div id="menulist"></div>
                  </ul>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
              <button type="button" class="btn btn-primary" id="sendOrderList" data-bs-dismiss="modal">注文確定</button>
            </div>
          </div>
        </div>
      </div>

      <!--FOOTER：署名表示　-->
      <footer class="pt-3 mt-4 text-muted border-top">
        &copy; 2022 MeM Co,Ltd
      </footer>
    </div>
  </main>
</body>



<!-- Bootstrap Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"
  integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js"
  integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.6.1.js" integrity="sha256-3zlB5s2uwoUzrXK3BT7AX3FyvojsraNFxCc2vC/7pNI="
  crossorigin="anonymous"></script>
<script src="/socket.io/socket.io.js"></script>

<script>
  //******************************************************************************//
  //****                   HTML読込後に実行処理する関数一覧                        ****//
  //******************************************************************************//

  //https://mdstage.com/wp-content/uploads/2019/05/sample_audio.mp3
  $(document).ready(function () {
    table();                  //テーブル表示関数
    getMenuList();            //商品一覧取得関数
    getOrderMenuList();       //注文追加・キッチン連携関数
    startCustomize();         //商品一覧変更シート遷移関数
    //renderOrderList();      //リロード時注文一覧表示関数(グローバル指定)
    //fetchOrderLsist();       //リロード時配列から注文一覧取得関数（グローバル指定）
    //deleteOrderMenuItem();  //注文一覧削除関数(グローバル指定)
  });
 
  //商品一覧変更用のシートえ遷移させる関数
  function startCustomize() {
    $("#startCustomize").on("click", function () {
      const url = 'https://docs.google.com/spreadsheets/d/1GWbxTcwg0jFoESiucSXHrzzgu0fVtpS_Ir3fFi30Ndo/edit#gid=1330995100';
      window.open(url, "_blunk");
    });
  };
  //注文一覧を表示する関数
  function renderOrderList(orderList) {
    for (const item of orderList) {
      $("#orderMenuList").append(
        '<div class="list-group-item list-group-item-action" aria-current="true" id="' + msg.id + '">' +
        '<div class="d-flex w-100 justify-content-between">' +
        '<h5 class="mb-1 fw-bold"><span class="badge bg-secondary fs-8">TABLE #0' + msg.table + '</span>&emsp;' + msg.menu + '</h5>' +
        '<small class="text-muted">' + msg.time + '</small>' +
        '</div>' +
        '<div class="input-group">' +
        '<div class="input-group-text" id="btnGroupAddon">数量</div>' +
        '<button type="button" class="btn btn-danger" id="deleteOrderMenuList">-0.5</button>' +
        '<input type="text" class="form-control" placeholder="" aria-label="" aria-describedby="btnGroupAddon" id="showRemarks" value="' + msg.quantity + '">' +
        '<button type="button" class="btn btn-outline-primary" id="deleteOrderMenuItem" value="' + msg.id + '" onclick="window.deleteOrderMenuItem(this.value);">DONE</button>' +
        '</div>' +
        '<small class="mb-1 fs-8">備考：' + msg.remarks + '</small>' +
        '</div>'
      );
    }
  }
  //GET APIから注文一覧を取得して描画する関数
  async function fetchOrderList() {
    // APIからJSONを取得する
    return fetch('./api/v1/orderList')
      .then((response) => response.json())
      .then((orderList) => {
        renderOrderList(orderList)
      })
  }
  //初回・リロード時注文一覧情報取得関数
  fetchOrderList();
  //******************************************************************************//
  //****                   table:テーブル一覧を表示する関数                       ****//
  //******************************************************************************//
  function table() {
    for (let i = 1; i <= 6; i++) {
      $("#table").append(
        '<div class="col">' +
        '<div class="card shadow-sm">' +
        '<svg class="bd-placeholder-img card-img-top fs-1" width="100%" height="180" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Placeholder: Thumbnail" preserveAspectRatio="xMidYMid slice" focusable="false"><title>Placeholder</title><rect width="100%" height="100%" fill="#55595c"/><text x="50%" y="50%" fill="#eceeef" dy=".3em">0' + i + '</text></svg>' +
        '<div class="card-body">' +
        '<p class="card-text">TABLE #0' + i + '</p>' +
        '<div class="d-flex justify-content-between align-items-center">' +
        '<div class="btn-group">' +
        '<button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#exampleModal" id="showOderListBtn' + i + '" data-id="' + i + '">注文追加</button>' +
        '</div>' +
        '</div>' +
        '</div>' +
        '</div>' +
        '</div>'
      );
      //テーブルナンバーを取得し、モーダルのトップタイトルに数字を反映
      $("#showOderListBtn" + i).on("click", function () {
        var num = $(this).data('id');
        $("#tableNumber").text(num);
      });
    }
  }
  //******************************************************************************//
  //****                getMenuList：商品一覧情報取得処理                         ****//
  //******************************************************************************//
  function getMenuList() {
    //yakiniku_base_kakeru_getMenuData APIのURLを登録し、for文でメニュー一覧を生成するメソッド
    let getMenuListUrl = "https://script.googleusercontent.com/macros/echo?user_content_key=EZXmzoBafbyPS-6Ixc6DRwqb_15rw39a2WZB21vm3zureTeQMeKPliUW6nZQnHWqtyBBqrs4W9rtwnmrs32ZaaWxuiIjU9K0m5_BxDlH2jW0nuo2oDemN9CCS2h10ox_1xSncGQajx_ryfhECjZEnKRx4GluyHKPsrb7MZoYGSx9aLlJMtuH1A999yVfFgGKCzQSEfljAkUMW9-RxnHaRcTvy1m0tLyP&lib=McBVuQVLovZoHBxBRGy3jZPlRnzlbkUi4";
    $.getJSON(getMenuListUrl, function (data) {
      for (let i in data) {
        //DBは100行を最大にしており、メニュー登録ない配列も取得するAPIの仕様になっているため、
        //配列内に文字列が存在するもののみhtml描写する。※つまりは、文字列なかったらスルー処理。
        if (data[i].item != '') {
          $("#menulist").append(
            '<li class="list-group-item">' +
            '<div class="row">' +
            '<div class="col-md-6">' +
            //商品名表示
            '<input class="form-check-input me-1" type="checkbox" name="menu" id="name' + i + '" value="' + data[i].item + '" aria-label="">' + data[i].item +
            '</div>' +
            '<div class="col-md-2 input-group-sm btn-group">' +
            //個数入力欄
            '<input type="number" min="1" step="1" class="form-control" name="menu_" id="quantity' + i + '" placeholder="個数">' +
            //'<button type="button" class="btn btn-plus btn-increment btn-primary" id="addQuantity' + i + '">+1</button>' +
            '</div>' +
            '<div class="col-md-4 input-group-sm">' +
            //備考入力欄
            '<input type="test" class="form-control" name="menu_" id="remarks' + i + '" placeholder="備考">' +
            '</div>' +
            '</div>' +
            '</li>'
          );
        }
      }//for文終了
      //注文確定ボタン押下時にチェック入っているメニューの一覧取得し、キッチンメニューに一覧表示
      //サーバに注文情報を送信。
      $(function () {
        $('#sendOrderList').click(function () {
          var now = new Date();                                 //時間を取得する関数の呼び出し
          var time = (now.getHours() + ':' + now.getMinutes()); //時刻表示のフォーマット作成し変数に代入
          for (let i in data) {                                 //SpreadSheetから全行呼び出し
            if (data[i].item != '') {                           //空欄は読み取らない
              if ($("#name" + i).prop("checked")) {             //チェックが入っている場合
                var tablenumber = $("#tableNumber").text();     //テーブルナンバーを変数に代入
                var name = $("#name" + i).val();                //商品名を変数に代入
                var quantity = $("#quantity" + i).val();        //個数を変数に代入
                var remarks = $("#remarks" + i).val();          //備考を変数に代入
                let socket = io();
                //上記の変数を結合。//server.jsに一覧情報を送信し、クライアントにブロードキャスト。
                socket.emit("orderMenuList", tablenumber + ',' + name + ',' + quantity + ',' + remarks + ',' + time);
                //処理完了後、全てのINPUTボックスの値をリセットする
                $("#name" + i).removeAttr("checked").prop("checked", false).change(); //チェックボックスのリセット
                $("#quantity" + i).val('');                                           //入力した数量のリセット
                $("#remarks" + i).val('');                                            //入力した備考のリセット
              }
            }
          }
        });
      });
    });
  }
  //******************************************************************************//
  //****                   getOrderMenuList:注文一覧の取得・表示                 ****//
  //******************************************************************************//
  function getOrderMenuList() {
    let socket = io();
    socket.on("orderMenuList", function (msg) {
      console.log(msg);
      $("#orderMenuList").append(
        '<div class="col">' +
        '<div class="list-group-item list-group-item-action shadow-sm p-2 mb-3 bg-body rounded" aria-current="true" id="' + msg.id + '">' +
        '<div class="d-flex w-100 justify-content-between">' +
        '<h6 class="mb-1 fw-bold"><span class="badge bg-secondary fs-8">TABLE #0' + msg.table + '</span>&emsp;' + msg.menu + '</h6>' +
        '<small class="text-muted">' + msg.time + '</small>' +
        '</div>' +
        '<div class="input-group">' +
        '<div class="input-group-text" id="btnGroupAddon">数量</div>' +
        //'<button type="button" class="btn btn-danger" id="deleteOrderMenuList">-0.5</button>' +
        '<input type="number" min="0", step="0.5" class="form-control" placeholder="" aria-label="" aria-describedby="btnGroupAddon" id="showQuantity" value="' + msg.quantity + '">' +
        '<button type="button" class="btn btn-outline-primary" id="deleteOrderMenuItem" value="' + msg.id + '" onclick="window.deleteOrderMenuItem(this.value);">DONE</button>' +
        '</div>' +
        '<small class="mb-1 fs-8">備考：' + msg.remarks + '</small>' +
        '</div>' +
        '</div>'
      );

      $("#playAudio").get(0).play();


    });
  }
  //******************************************************************************//
  //****                 deleteOrderMenuItem:注文一覧の削除                     ****//
  //******************************************************************************//
  function deleteOrderMenuItem(id) {
    console.log("DELETE ID: " + id);
    $("#" + id).remove();
  };
</Script>
</body>

</html>